<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Auction - Projector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #F2C94C; --dark-red: #1a0505; }
        body { font-family: 'Roboto Slab', serif; background: radial-gradient(circle at center, #2a0a0a 0%, #000000 100%); color: var(--gold); overflow: hidden; }
        .font-imperial { font-family: 'Cinzel', serif; }
        .glow-gold { text-shadow: 0 0 10px rgba(242, 201, 76, 0.5); }
        .box-glow { box-shadow: 0 0 20px rgba(242, 201, 76, 0.2), inset 0 0 20px rgba(242, 201, 76, 0.1); }
        
        .grid-cell { background: linear-gradient(to bottom, #4a0404, #220202); border: 1px solid #5c4110; }
        .grid-cell.active { background: #F2C94C; color: #000; transform: scale(1.1); box-shadow: 0 0 30px #F2C94C; z-index: 10; border-color: #fff; }
        .grid-cell.used { opacity: 0.2; filter: grayscale(1); }

        .perspective-container { perspective: 1000px; }
        .flipper { position: relative; width: 100%; height: 100%; transition: transform 0.8s; transform-style: preserve-3d; }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 1rem; border: 4px solid var(--gold); }
        .front { background: linear-gradient(135deg, #a60000, #3a0000); display: flex; align-items: center; justify-content: center;}
        .back { background: #FDF5E6; color: #000; transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; }
        .is-revealed .flipper { transform: rotateY(180deg); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="h-20 flex justify-between items-center px-8 border-b border-[#5c4110] bg-[#1a0505]">
        <div class="flex items-center gap-4">
            <span class="text-4xl">üßß</span>
            <h1 class="font-imperial text-3xl font-bold tracking-[0.2em] text-[#F2C94C] glow-gold">IMPERIAL AUCTION</h1>
        </div>
        <div class="flex gap-8 font-imperial text-lg tracking-widest text-[#cfc09f]">
            <div>ROUND <span id="round-num" class="text-white font-bold ml-2">1</span></div>
            <div>STATUS: <span id="status-text" class="text-[#F2C94C]">IDLE</span></div>
            <button onclick="toggleAdmin()" class="text-[#5c4110] hover:text-[#F2C94C] transition-colors" title="Admin Login">
                üîí
            </button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden p-8">
        
        <div id="view-grid" class="absolute inset-0 p-8 flex gap-8 transition-opacity duration-500 opacity-100 z-10 bg-black/50 backdrop-blur-sm">
            <div class="w-3/4 flex flex-col items-center justify-center">
                <div id="grid-container" class="grid grid-cols-5 gap-4 w-full max-w-3xl aspect-square"></div>
                <button onclick="adminAction('DRAW')" id="btn-draw" class="mt-8 px-12 py-4 bg-[#F2C94C] hover:bg-[#ffe082] text-black font-imperial font-black text-2xl tracking-widest uppercase rounded box-glow transition-transform active:scale-95">
                    Draw Fortune
                </button>
            </div>
            
            <div class="w-1/4 bg-[#0f0000] border border-[#5c4110] rounded p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-[#5c4110] pb-2">
                    <h2 class="font-imperial text-[#F2C94C]">Active Teams</h2>
                    <button id="btn-reset" onclick="resetGame()" class="hidden text-xs text-red-500 hover:text-red-400 uppercase font-bold border border-red-900 px-2 py-1 rounded">Reset Game</button>
                </div>
                <div id="player-list" class="flex-1 overflow-y-auto space-y-2">
                    </div>
            </div>
        </div>

        <div id="view-auction" class="absolute inset-0 p-8 flex gap-8 transition-opacity duration-500 opacity-0 pointer-events-none">
            
            <div class="w-1/2 flex flex-col items-center justify-center relative">
                <div class="perspective-container w-96 h-[500px] mb-8">
                    <div id="card-flipper" class="flipper">
                        <div class="front box-glow">
                            <span class="text-9xl opacity-20 absolute font-imperial">Á¶è</span>
                            <span id="auction-card-num" class="text-8xl font-black text-[#F2C94C] glow-gold z-10">?</span>
                        </div>
                        <div class="back box-glow border-[#F2C94C]">
                            <h3 class="font-imperial text-red-900 text-xl font-bold mb-4 uppercase tracking-widest" id="card-name-display">Card Name</h3>
                            <p id="prize-text" class="font-serif text-4xl font-bold text-black leading-tight">--</p>
                        </div>
                    </div>
                </div>

                <div id="timer-box" class="text-center transition-all duration-300">
                    <div class="text-[#cfc09f] text-sm uppercase tracking-widest">Time Remaining</div>
                    <div id="countdown-display" class="text-6xl font-imperial font-black text-white glow-gold">10s</div>
                </div>

                <button onclick="adminAction('NEXT')" id="btn-next" class="hidden mt-4 px-8 py-3 border-2 border-[#F2C94C] text-[#F2C94C] font-imperial font-bold tracking-widest rounded hover:bg-[#F2C94C] hover:text-black">
                    NEXT ROUND
                </button>
            </div>

            <div class="w-1/2 bg-[#0f0000] border border-[#5c4110] rounded-lg p-6 flex flex-col box-glow">
                <h2 class="font-imperial text-center text-2xl text-[#F2C94C] mb-6 border-b border-[#5c4110] pb-4">IMPERIAL BID LEDGER</h2>
                <div id="ledger-list" class="flex-1 overflow-y-auto space-y-2"></div>
                <div class="mt-6 pt-6 border-t border-[#5c4110] text-center">
                    <div class="text-[#cfc09f] text-xs uppercase tracking-widest mb-1">Current Highest Offering</div>
                    <div class="flex justify-center items-center gap-2">
                        <span class="text-2xl text-[#F2C94C]">RM</span>
                        <span id="display-highest-bid" class="text-6xl font-imperial font-black text-white glow-gold">0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // -----------------------------------------------------------
        // üî¥ PASTE YOUR REAL KEYS HERE üî¥
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "YOUR_REAL_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // -----------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, get, remove, onChildAdded, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let gameState = { phase: 'GRID', round: 1, highestBid: 0, lastBidTime: 0 };
        let envelopesStatus = {};
        let isAdmin = false; 

        // üî¥ PASTE YOUR CUSTOM CARDS DATA HERE (The 25 Items) üî¥
        const cardsData = [
            { id: 1, name: "The Magic Bowl", desc: "+3000 Points", val: 3000 },
            { id: 2, name: "The Market Crash", desc: "Divide Score by 2", val: 0.5 },
             // ... paste the rest of your 25 items here ...
             // If you don't paste them, it will default to these 2 examples only!
        ];

        // --- DOM ---
        const viewGrid = document.getElementById('view-grid');
        const viewAuction = document.getElementById('view-auction');
        const gridContainer = document.getElementById('grid-container');
        const playerList = document.getElementById('player-list');
        const countdownDisplay = document.getElementById('countdown-display');
        const cardFlipper = document.getElementById('card-flipper');
        const prizeText = document.getElementById('prize-text');
        const cardNameDisplay = document.getElementById('card-name-display');

        // --- GAME LOOP (TIMER) ---
        setInterval(() => {
            if (gameState.phase === 'BIDDING' && gameState.lastBidTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - gameState.lastBidTime) / 1000);
                const remaining = 10 - elapsed;

                if (remaining > 0) {
                    countdownDisplay.innerText = remaining + "s";
                    countdownDisplay.className = "text-6xl font-imperial font-black text-white glow-gold";
                } else {
                    countdownDisplay.innerText = "SOLD!";
                    countdownDisplay.className = "text-6xl font-imperial font-black text-red-500 blink";
                    
                    // Trigger Sold State
                    if (gameState.highestBid > 0) { 
                         update(ref(db, 'gameState'), {
                             phase: 'SOLD',
                             soldTo: gameState.leaderId,
                             soldToName: gameState.leaderName
                         });
                    }
                }
            } else if (gameState.phase === 'SOLD') {
                countdownDisplay.innerText = `SOLD TO ${gameState.soldToName}`;
                countdownDisplay.className = "text-3xl font-imperial text-[#F2C94C]";
            }
        }, 500);

        // --- LISTENERS ---
        onValue(ref(db, 'gameState'), (snap) => {
            const data = snap.val();
            if(!data) return;
            gameState = data;
            
            document.getElementById('display-highest-bid').innerText = (gameState.highestBid || 0).toLocaleString();
            document.getElementById('round-num').innerText = gameState.round;
            document.getElementById('status-text').innerText = gameState.phase;

            // View Switching
            if (gameState.phase === 'GRID') {
                viewGrid.style.display = 'flex';
                viewAuction.style.opacity = '0';
                setTimeout(() => viewAuction.style.display = 'none', 500);
                viewGrid.style.opacity = '1';
                
                cardFlipper.classList.remove('is-revealed');
                document.getElementById('btn-next').classList.add('hidden');
            } else {
                viewGrid.style.opacity = '0';
                setTimeout(() => viewGrid.style.display = 'none', 500);
                viewAuction.style.display = 'flex';
                setTimeout(() => viewAuction.style.opacity = '1', 100);

                if(gameState.currentCard) {
                    document.getElementById('auction-card-num').innerText = gameState.currentCard;
                    const card = cardsData.find(c => c.id == gameState.currentCard);
                    if(card) {
                        cardNameDisplay.innerText = card.name;
                        prizeText.innerText = card.desc;
                    }
                }

                if(gameState.phase === 'REVEALED') {
                    cardFlipper.classList.add('is-revealed');
                    document.getElementById('btn-next').classList.remove('hidden');
                }
            }
        });

        // Player List & Admin Kick
        onValue(ref(db, 'teams'), (snap) => {
            playerList.innerHTML = '';
            snap.forEach(child => {
                const team = child.val();
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-[#1a0505] p-2 rounded border border-[#5c4110]';
                
                // Admin Button Logic
                const deleteBtn = isAdmin 
                    ? `<button onclick="kickPlayer('${child.key}')" class="text-red-500 hover:bg-red-900 px-2 rounded font-bold">‚úï</button>` 
                    : '';

                div.innerHTML = `
                    <span class="text-white text-sm truncate w-24">${team.name}</span>
                    ${deleteBtn}
                `;
                playerList.appendChild(div);
            });
        });

        // --- FUNCTIONS ---
        // These are attached to window so buttons can find them
        window.kickPlayer = (id) => {
            if(confirm("Kick this player?")) remove(ref(db, `teams/${id}`));
        };

        window.resetGame = () => {
            if(confirm("FULL RESET? This cannot be undone.")) {
                set(ref(db), {
                    gameState: { phase: 'GRID', round: 1, highestBid: 0 },
                    envelopes: {},
                    teams: {},
                    currentRoundBids: {},
                    bidQueue: {}
                });
            }
        };

        window.toggleAdmin = () => {
            const password = prompt("Enter Admin Password:");
            if (password === "admin123*") {
                isAdmin = true;
                document.getElementById('btn-reset').classList.remove('hidden');
                // Force refresh list to show X buttons
                get(ref(db, 'teams')).then((snap) => {
                     // The onValue listener will handle updates automatically if we change data,
                     // but to force UI update without data change, we can just reload or wait.
                     // For now, let's just alert.
                     alert("Admin Mode Unlocked. Kick & Reset enabled.");
                });
            } else {
                alert("Access Denied.");
            }
        };

        window.adminAction = (action) => {
            if (action === 'DRAW') {
                let available = [];
                for(let i=1; i<=25; i++) if(!envelopesStatus[i]) available.push(i);
                if(available.length === 0) return alert("All envelopes used!");

                let loops = 0;
                const interval = setInterval(() => {
                    document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('active'));
                    const rand = available[Math.floor(Math.random() * available.length)];
                    const el = document.getElementById(`grid-cell-${rand}`);
                    if(el) el.classList.add('active');
                    
                    loops++;
                    if (loops > 15) {
                        clearInterval(interval);
                        const finalCard = available[Math.floor(Math.random() * available.length)];
                        
                        update(ref(db, 'gameState'), {
                            phase: 'BIDDING',
                            currentCard: finalCard,
                            highestBid: 0,
                            lastBidTime: Date.now() + 100000 // Buffer until first bid
                        });
                        set(ref(db, 'currentRoundBids'), {});
                    }
                }, 100);
            }
            if (action === 'NEXT') {
                 if(gameState.currentCard) update(ref(db, `envelopes/${gameState.currentCard}`), true);
                 update(ref(db, 'gameState'), { 
                    phase: 'GRID', 
                    round: (gameState.round||1)+1, 
                    highestBid: 0 
                 });
            }
        };
        
        // Render Grid
        onValue(ref(db, 'envelopes'), (snap) => {
            const used = snap.val() || {};
            gridContainer.innerHTML = '';
            for(let i=1; i<=25; i++) {
                const div = document.createElement('div');
                div.className = `grid-cell rounded-md aspect-square flex items-center justify-center text-2xl font-imperial font-bold cursor-default transition-all ${used[i] ? 'used' : 'hover:border-[#F2C94C]'}`;
                div.innerHTML = `<span class="${used[i] ? '' : 'text-[#F2C94C]'}">${i}</span>`;
                gridContainer.appendChild(div);
            }
        });
        
        // Bid Queue
        const bidQueueRef = ref(db, 'bidQueue');
        onChildAdded(bidQueueRef, async (snapshot) => {
            const request = snapshot.val();
            const requestKey = snapshot.key;
            if(!request) return;

            try {
                const stateSnap = await get(ref(db, 'gameState'));
                const state = stateSnap.val();

                if (state.phase !== 'BIDDING' || request.amount <= (state.highestBid || 0)) {
                    await remove(ref(db, `bidQueue/${requestKey}`));
                    return;
                }

                const newBidderRef = ref(db, `teams/${request.teamId}`);
                const newBidderSnap = await get(newBidderRef);
                const newBidder = newBidderSnap.val();

                if (!newBidder || newBidder.balance < request.amount) {
                    await remove(ref(db, `bidQueue/${requestKey}`));
                    return;
                }

                if (state.leaderId) {
                    const oldBidderRef = ref(db, `teams/${state.leaderId}`);
                    const oldSnap = await get(oldBidderRef);
                    if (oldSnap.exists()) {
                        await update(oldBidderRef, { balance: oldSnap.val().balance + state.highestBid });
                    }
                }

                await update(newBidderRef, { balance: newBidder.balance - request.amount });

                await update(ref(db, 'gameState'), {
                    highestBid: request.amount,
                    leaderId: request.teamId,
                    leaderName: newBidder.name,
                    lastBidTime: Date.now() // RESET TIMER
                });

                await push(ref(db, 'currentRoundBids'), {
                    teamName: newBidder.name,
                    amount: request.amount,
                    timestamp: Date.now()
                });

            } catch (e) {
                console.error("Bid Error", e);
            }
            await remove(ref(db, `bidQueue/${requestKey}`));
        });

    </script>
</body>
</html>